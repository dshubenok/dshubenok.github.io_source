



<!doctype html>
<html lang="ru" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Копировать в буфер">
      
        <meta name="lang:clipboard.copied" content="Скопировано в буфер">
      
        <meta name="lang:search.language" content="en, ru">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="Совпадений не найдено">
      
        <meta name="lang:search.result.one" content="Найдено 1 совпадение">
      
        <meta name="lang:search.result.other" content="Найдено # совпадений">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/img/favicon.ico">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>SQLAlchemy - NoBullshit Academy</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#_1" tabindex="0" class="md-skip">
        Перейти к содержанию
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="NoBullshit Academy" aria-label="NoBullshit Academy" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              NoBullshit Academy
            </span>
            <span class="md-header-nav__topic">
              
                SQLAlchemy
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Поиск" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Начните печатать для поиска
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link">
        Хоум
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../data_science/" class="md-tabs__link">
          Data Science
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../" class="md-tabs__link md-tabs__link--active">
          FastAPI/Starlette
        </a>
      
    </li>
  

      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="NoBullshit Academy" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    NoBullshit Academy
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Хоум" class="md-nav__link">
      Хоум
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Data Science
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Data Science
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../data_science/" title="Вступление" class="md-nav__link">
      Вступление
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../data_science/lesson1/" title="Урок 1" class="md-nav__link">
      Урок 1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../data_science/lesson2/" title="Урок 2" class="md-nav__link">
      Урок 2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../data_science/lesson3/" title="Урок 3" class="md-nav__link">
      Урок 3
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      FastAPI/Starlette
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        FastAPI/Starlette
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Вступление" class="md-nav__link">
      Вступление
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lesson1/" title="FastAPI (REST)" class="md-nav__link">
      FastAPI (REST)
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="./" title="SQLAlchemy" class="md-nav__link md-nav__link--active">
      SQLAlchemy
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lesson3/" title="Bash" class="md-nav__link">
      Bash
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lesson4/" title="Git" class="md-nav__link">
      Git
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lesson5/" title="SQL" class="md-nav__link">
      SQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lesson6/" title="asyncio" class="md-nav__link">
      asyncio
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lesson7/" title="Telegram-bots" class="md-nav__link">
      Telegram-bots
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../about/" title="Эбаут" class="md-nav__link">
      Эбаут
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <p>Выбор в качестве основного ORM, всякие сложные запросы, echo=True с исследованием того, что происходит. Постоянно держит в голове, что ORM лишь обертка и смотрит на то, какие запросы она генерит.</p>
<p>Что почитать:</p>
<p>Jason Myers, Rick Copeland, <strong>Essential SQLAlchemy, 2nd edition, 2016</strong></p>
<p><a href=""></a></p>
<h1 id="_1">Введение</h1>
<p>Пришло время добавить в приложение реальные данные. FastAPI позволяет работать с любой базой данных, как напрямую, так и с использованием ORM. В этой теме вы начнете знакомиться с самой популярной ORM-библиотекой — SQLAlchemy: настроите подключение к базе данных, опишете данные в виде классов и научитесь выполнять CRUD-операции с ними.</p>
<p>Для начала установите SQLAlchemy, предварительно убедившись, что вы находитесь в виртуальном окружении:</p>
<div class="codehilite"><pre><span></span><code><span class="err">pip install sqlalchemy</span>
</code></pre></div>


<p>Создайте директорию <code>data</code> со следующей структурой:</p>
<div class="codehilite"><pre><span></span><code><span class="err">app</span>
<span class="err">├── data</span>
<span class="err">│   ├── __init__.py</span>
<span class="err">│   ├── database.py</span>
<span class="err">│   ├── models.py</span>
<span class="err">│   ├── schemas.py</span>
<span class="err">│   ├── crud.py</span>
</code></pre></div>


<p>Файл <code>__init__.py</code> нужен для того, чтобы объявить директорию <code>data</code> пакетом, а все вложенные в неё файлы — модулями.</p>
<p>Файл <code>database.py</code> будет отвечать за инициацию работу с базой данных. Код, который здесь находится, содержит базовые настройки и обычно не меняется. Здесь вы указываете, к какой базе данных нужно подключиться, делаете все необходимые импорты и фиксируете необходимые настройки.</p>
<p><code>[models.py](http://models.py/)</code> нужен для описания моделей данных — в нем вы описываете таблицы базы данных в виде классов.</p>
<p>В файле <code>crud.py</code> вы напишете функции для работы с базой данных — функции для создания, чтения, изменения или удаления данных.</p>
<p><strong>Оформляем файл <code>data/database.py</code></strong></p>
<p>Начнем с создания файла настроек.</p>
<p>Создайте подключение к базе данных и присвойте его переменной engine (англ. "engine" - двигатель, мотор). Для этого используется функция create_engine() из пакета sqlalchemy. В качестве аргумента функции нужно передать описание базы данных: <code>sqlite:///yam.db</code></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;sqlite:///yam.db&#39;</span><span class="p">)</span>
</code></pre></div>


<p>Функция create_engine() создает экземпляр класса Engine и описывает диалект базы данных, в нашем случае все команды будет обрабатывать</p>
<blockquote>
<p>Если передать функции create_engine необязательный параметр echo=True, то вы сможете видеть результат выполнения всех обращений к базе данных в реальном времени в командной строке.</p>
</blockquote>
<p>Подключение настроено, теперь вам нужен интерфейс для работы с базой данных. Для этого необходимо создать класс <code>Session</code> с помощью функции <code>sessionmaker</code> из пакета <code>sqlalchemy.orm</code> и связать его с объектом <code>engine</code>, то есть передать в качестве аргумента в параметр <code>bind</code> наш созданный ранее <code>engine:</code></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</code></pre></div>


<p>Сессия — это инструмент работы с базой данных, о ней мы подробно поговорим в следующем уроке.</p>
<h1 id="_2">Модели</h1>
<h2 id="learning-outcomes">Learning outcomes</h2>
<p>Это будет самый объемный и сложный блок курса.</p>
<p>Студент научится архитектурно правильно добавлять алхимию в проект.</p>
<p>Узнает, в чем разница между уже изученным Django ORM и почему Алхимия выигрывает.</p>
<p>Опишет модели и CRUD-операции для работы с ними.</p>
<p>Чтобы начать работать с данными, необходимо рассказать SQLAlchemy о наших таблицах, то есть описать их в виде классов, наследуясь от базового класса <strong>Base</strong>, который мы проимпортировали в файле <a href="http://database.py/">database.py</a>.</p>
<blockquote>
<p>SQLAlchemy поддерживает два способа описания таблиц — классический и декларативный. Второй способ почти всегда предпочтительней и удобнее, его мы и будем рассматривать. Про отличия двух способов можно почитать здесь: https://docs.sqlalchemy.org/en/13/orm/mapping_styles.html#classical-mappings</p>
</blockquote>
<p>Откройте в редакторе кода файл <code>data/models.py</code></p>
<p>Проимпортируйте базовый класс <code>Base</code> из модуля <a href="http://database.py/">database.py</a> и создайте классы таблиц, наследуясь от класса <code>Base</code>. Имя класса будет соответствовать таблице в базе данных. Укажите <code>__tablename__</code> — это необязательный параметр, но он нужен для удобства:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">.database</span> <span class="kn">import</span> <span class="n">Base</span>


<span class="k">class</span> <span class="nc">Review</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;reviews&quot;</span>
</code></pre></div>


<p>Теперь опишите атрибуты классов, которые будут столбцами в этих таблицах. Названия атрибутов будут соответствовать названиям столбцов. В качестве значения по умолчанию для атрибута присваиваем <code>Column</code> из библиотеки <code>sqlalchemy</code> и передаем в качестве аргумента тип столбца и другие необязательные параметры.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">.database</span> <span class="kn">import</span> <span class="n">Base</span>


<span class="k">class</span> <span class="nc">Review</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;reviews&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div>


<p>Опишите отношения между таблицами. Для этого проимпортируйте <code>relationship</code> из <code>sqlalchemy.orm</code></p>
<h1 id="_3">Запросы</h1>
<p>За работу с базой данных отвечает объект <strong>session</strong>.</p>
<p>Сессию можно представлять себе как контейнер, в который вы добавляете какие-то объекты, которые хотите записать в базу. Делается это с помощью метода <strong>add</strong>: <code>session.add</code></p>
<p>Вы можете посмотреть, какие объекты находятся в этом контейнере с помощью метода <strong>new</strong>: <code>session.new</code></p>
<p>Наконец, чтобы отправить контейнер с объектами для записи в базу данных, вызывается метод <code>session.commit</code></p>
<p>У сессии есть метод query.</p>
<h1 id="crud">CRUD</h1>
<p>Откройте файл <code>data/crud.py</code></p>
<p>В этом файле необходимо описать функции для операций с данными в базе данных.</p>
<p>Вы уже умеете делать запросы, вызывая метод .query у объекта session и фильтровать результаты с помощью метода .filter . Всё, что осталось сделать — упаковать эти вызовы в функции:</p>
<div class="codehilite"><pre><span></span><code><span class="err">def get_author(db: Session, author_id: int):</span>
<span class="err">    return db.query(models.Author).filter(models.Author.id == author_id).first()</span>
</code></pre></div>


<p><em>Функция, возвращающая объект автора отзыва по его </em><em>id</em><em>.</em></p>
<div class="codehilite"><pre><span></span><code><span class="err">def create_author(db: Session, author: schemas.AuthorCreate):</span>
<span class="err">    db_author = models.Author(email=author.email)</span>
<span class="err">    db.add(db_author)</span>
<span class="err">    db.commit()</span>
<span class="err">    db.refresh(db_author)</span>
<span class="err">    return db_author</span>
</code></pre></div>


<p><em>Функция, записывающая в базу данных нового автора.</em></p>
<ul>
<li>
<p>Задание 1</p>
<p>Опишите функцию get_authors, которая возвращает список объектов авторов.</p>
</li>
</ul>
<h1 id="_4">Схемы</h1>
<p>Про Type Hints сначала.</p>
<p>Всегда нужно проводить проверку данных перед тем, как записывать их в базу данных. Проверка данных (или валидация) может выполняться разными способами.</p>
<p>Если данные не проходят проверку, то возвращается ответ с указанием.</p>
<h1 id="_5">Миграции</h1>
<h2 id="learning-outcomes_1">Learning outcomes</h2>
<p>Alembic — это инструмент для миграций Алхимии. Студент научится работать с этим инструментом и делать миграции правильно. В Джанго все делалось двумя командами, здесь же всё несколько сложнее.</p>
<p>Миграции — это система контроля версий для базы данных.</p>
<p>Представьте ситуацию: вы создали базу данных, начали с ней работать, записывать в неё, а потом вдруг осознали, что в таблице не хватает ещё одного обязательного поля. Казалось бы, можно просто добавить это поле, но как быть с уже имеющимися данными? Новое поле должно быть обязательным, поэтому мы должны чем-то заполнить "пропуски".</p>
<p>Для этого существует механизм миграций. Вы уже сталкивались с ним в предыдущем курсе, когда создавали таблицы через Django ORM.</p>
<p>Для этого существует инструмент <strong>Alembic</strong>.</p>
<h1 id="_6">Параметры запросов</h1>
<h2 id="learning-outcomes_2">Learning outcomes</h2>
<p>Студент реализует (напишет код) возможность производить манипуляции с данными: фильтровать (с помощью алхимии), сортировать, искать по ключевым словам, устанавливать лимит (например, "выдать только 100 перых записей"), пагинация и так далее. И передавать это в виде параметров запросов.</p>
<h1 id="_7">Документирование</h1>
<p><a href="https://developer.github.com/v3/">https://developer.github.com/v3/</a></p>
<p>Как пример очень хорошей документации.</p>
<p><a href="http://www.writethedocs.org/guide/writing/beginners-guide-to-docs/">http://www.writethedocs.org/guide/writing/beginners-guide-to-docs/</a></p>
<p>Как писать документацию.</p>
<h1 id="_8">Тестирование</h1>
<p>да. будет.</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../lesson1/" title="FastAPI (REST)" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Назад
                </span>
                FastAPI (REST)
              </span>
            </div>
          </a>
        
        
          <a href="../lesson3/" title="Bash" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Вперед
                </span>
                Bash
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 NoBullshit Academy
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
        
        
          
          <script src="../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
          
            
              
              
                <script src="../../assets/javascripts/lunr/lunr.ru.js"></script>
              
            
          
          
            <script src="../../assets/javascripts/lunr/lunr.multi.js"></script>
          
        
      
      <script>app.initialize({version:"1.1",url:{base:"../.."}})</script>
      
    
  </body>
</html>